<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>- yclooper</title><meta name=Description content><meta property="og:title" content><meta property="og:description" content="前一段时间观察到集群有个别 pod 在 创建的时候会发生 restart 的情况。
集群的状态是正常的，猜测大概率是因为探测器配置的原因，先查看日志验证一下：
Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Pulling 7m21s kubelet, mt-hulk-k8s-ep-test305.mt Pulling image &#34;registry-hulk.sankuai.com/sankuai/centos:offline_lwc_init_211216_centos6&#34; Normal Pulled 7m21s kubelet, mt-hulk-k8s-ep-test305.mt Successfully pulled image &#34;registry-hulk.sankuai.com/sankuai/centos:offline_lwc_init_211216_centos6&#34; Normal Created 7m17s kubelet, mt-hulk-k8s-ep-test305.mt Created container hulk-init Normal Started 7m17s kubelet, mt-hulk-k8s-ep-test305.mt Started container hulk-init Normal Pulled 6m26s kubelet, mt-hulk-k8s-ep-test305.mt Container image &#34;registry-hulk.sankuai.com/custom_test/com.sankuai.cloudide.server/cloudide-jetbrains-idea:2022-02-21-01&#34; already present on machine Normal Created 6m23s kubelet, mt-hulk-k8s-ep-test305.mt Created container ide Normal Started 6m23s kubelet, mt-hulk-k8s-ep-test305."><meta property="og:type" content="article"><meta property="og:url" content="http://example.org/wiki/pod-%E5%90%AF%E5%8A%A8%E6%97%B6%E9%87%8D%E5%90%AF/"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="前一段时间观察到集群有个别 pod 在 创建的时候会发生 restart 的情况。
集群的状态是正常的，猜测大概率是因为探测器配置的原因，先查看日志验证一下：
Events: Type Reason Age From Message ---- ------ ---- ---- ------- Normal Pulling 7m21s kubelet, mt-hulk-k8s-ep-test305.mt Pulling image &#34;registry-hulk.sankuai.com/sankuai/centos:offline_lwc_init_211216_centos6&#34; Normal Pulled 7m21s kubelet, mt-hulk-k8s-ep-test305.mt Successfully pulled image &#34;registry-hulk.sankuai.com/sankuai/centos:offline_lwc_init_211216_centos6&#34; Normal Created 7m17s kubelet, mt-hulk-k8s-ep-test305.mt Created container hulk-init Normal Started 7m17s kubelet, mt-hulk-k8s-ep-test305.mt Started container hulk-init Normal Pulled 6m26s kubelet, mt-hulk-k8s-ep-test305.mt Container image &#34;registry-hulk.sankuai.com/custom_test/com.sankuai.cloudide.server/cloudide-jetbrains-idea:2022-02-21-01&#34; already present on machine Normal Created 6m23s kubelet, mt-hulk-k8s-ep-test305.mt Created container ide Normal Started 6m23s kubelet, mt-hulk-k8s-ep-test305."><meta name=application-name content="yclooper"><meta name=apple-mobile-web-app-title content="yclooper"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://example.org/wiki/pod-%E5%90%AF%E5%8A%A8%E6%97%B6%E9%87%8D%E5%90%AF/><link rel=prev href=http://example.org/wiki/vim/><link rel=next href=http://example.org/wiki/k8s-node-notready/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/example.org\/wiki\/pod-%E5%90%AF%E5%8A%A8%E6%97%B6%E9%87%8D%E5%90%AF\/"},"genre":"wiki","wordcount":187,"url":"http:\/\/example.org\/wiki\/pod-%E5%90%AF%E5%8A%A8%E6%97%B6%E9%87%8D%E5%90%AF\/","publisher":{"@type":"Organization","name":"作者"},"author":{"@type":"Person","name":"作者"},"description":""}</script></head><body header-desktop header-mobile><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':(''==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:''==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=yclooper>yclooper</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=yclooper>yclooper</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/>Posts</a><a class=menu-item href=/tags/>Tags</a><a class=menu-item href=/categories/>Categories</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class="page single special"><h1 class="single-title animated pulse faster"></h1><div class=content id=content><p>前一段时间观察到集群有个别 pod 在 创建的时候会发生 restart 的情况。</p><p>集群的状态是正常的，猜测大概率是因为探测器配置的原因，先查看日志验证一下：</p><pre><code>Events:
  Type     Reason            Age                    From                                Message
  ----     ------            ----                   ----                                -------
  Normal   Pulling           7m21s                  kubelet, mt-hulk-k8s-ep-test305.mt  Pulling image &quot;registry-hulk.sankuai.com/sankuai/centos:offline_lwc_init_211216_centos6&quot;
  Normal   Pulled            7m21s                  kubelet, mt-hulk-k8s-ep-test305.mt  Successfully pulled image &quot;registry-hulk.sankuai.com/sankuai/centos:offline_lwc_init_211216_centos6&quot;
  Normal   Created           7m17s                  kubelet, mt-hulk-k8s-ep-test305.mt  Created container hulk-init
  Normal   Started           7m17s                  kubelet, mt-hulk-k8s-ep-test305.mt  Started container hulk-init
  Normal   Pulled            6m26s                  kubelet, mt-hulk-k8s-ep-test305.mt  Container image &quot;registry-hulk.sankuai.com/custom_test/com.sankuai.cloudide.server/cloudide-jetbrains-idea:2022-02-21-01&quot; already present on machine
  Normal   Created           6m23s                  kubelet, mt-hulk-k8s-ep-test305.mt  Created container ide
  Normal   Started           6m23s                  kubelet, mt-hulk-k8s-ep-test305.mt  Started container ide
  Normal   Pulling           6m22s                  kubelet, mt-hulk-k8s-ep-test305.mt  Pulling image &quot;registry-hulk.sankuai.com/sankuai/centos:offline_lwc_sidecar_220104_centos6&quot;
  Normal   Pulled            6m22s                  kubelet, mt-hulk-k8s-ep-test305.mt  Successfully pulled image &quot;registry-hulk.sankuai.com/sankuai/centos:offline_lwc_sidecar_220104_centos6&quot;
  Normal   Created           6m21s                  kubelet, mt-hulk-k8s-ep-test305.mt  Created container hulk-sidecar
  Normal   Started           6m20s                  kubelet, mt-hulk-k8s-ep-test305.mt  Started container hulk-sidecar
  Warning  Unhealthy         6m13s                  kubelet, mt-hulk-k8s-ep-test305.mt  Liveness probe failed: dial tcp 10.199.150.79:9999: connect: connection refused
  Warning  Unhealthy         6m11s (x6 over 6m16s)  kubelet, mt-hulk-k8s-ep-test305.mt  Readiness probe failed: dial tcp 10.199.150.79:9999: connect: connection refused
</code></pre><p>通过日志中 Unhealthy 的信息可以判断，因为存活探测器（LivenessProbe）和就绪探测器（ReadnessProbe）检查失败，容器被杀死重建了。</p><p>Pod 定义的 yaml 文件：</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>         </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9999</span><span class=w>
</span><span class=w>            </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>            </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span><span class=w>          </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9999</span><span class=w>
</span><span class=w>            </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span><span class=w>            </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span></code></pre></div><p>我们的服务是比较重的，启动需要较多的初始化时间，我们修改一下 readinessProbe 的参数。为了保护服务启动，我们添加一下启动探测器（startupProbe）。修改后端的 yaml 为：</p><div class=highlight><pre class=chroma><code class=language-yaml data-lang=yaml><span class=w>          </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9999</span><span class=w>
</span><span class=w>            </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span><span class=w>            </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span><span class=w>          </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9999</span><span class=w>
</span><span class=w>            </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span><span class=w>            </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span><span class=w>          </span><span class=nt>startupProbe</span><span class=p>:</span><span class=w>
</span><span class=w>            </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span><span class=w>              </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>9999</span><span class=w>
</span><span class=w>            </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>
</span><span class=w>            </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></code></pre></div><ul><li><code>failureThreshold</code>：当探测失败时，Kubernetes 的重试次数。 存活探测情况下的放弃就意味着重新启动容器。 就绪探测情况下的放弃 Pod 会被打上未就绪的标签。默认值是 3。最小值是 1。</li><li><code>periodSeconds</code>：执行探测的时间间隔（单位是秒）。默认是 10 秒。最小值是 1。</li></ul><p>这样设置可以让 pod 有 200 s 的时间来完成启动</p><h3 id=验证>验证</h3><p>我们先用脚本创建一批 pod，等待完成之后，我们用脚本查看发生重启的 pod</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>kubectl get pods -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[*].status.containerStatuses[?(@.restartCount&gt;=1)].name}&#39;</span> -n <span class=nb>test</span> 
</code></pre></div><p>多次验证，没有 pod在创建时重启的现象了</p></div></div></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.79.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank></a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=/lib/smooth-scroll/smooth-scroll.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>